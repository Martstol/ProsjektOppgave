\section{Math}

The math for the wind simulation is based on the computational fluid dynamics
model described in the Background chapter. This model was included in the first 
snow simulator by Saltvik\cite{originalSnowThesis} and later in the GPU 
implementation by Eidissen\cite{gpuSnowThesis}.

In computational fluid dynamics, the Navier-Stokes equations are used to describe 
fluid flow. In the Background chapter this equation was reduced to the 
incompressible Euler equation by assuming zero viscosity and a density equal to 
one. Further more it is assumed that the contribution of external forces like 
gravity are negligible. These assumptions leads to the following equations. 

\begin{equation} 
	\tag{momentum equation}
	\pOne{t}u  = -(u \cdot \nabla)u - \nabla p
\end{equation}

\begin{equation}
	\tag{continuity equation}
	\nabla \cdot u = 0
\end{equation}

$u$ is the wind velocity field, a three dimensional field of three dimensional 
velocity vectors. $p$ is the pressure field, a three dimensional field of scalar 
values. The momentum equation is an expression for the change in velocity of the
fluid. Given an initial velocity $u_n$ at time $t_n$, we can compute the velocity 
$u_{n+1}$ at time $t_{n+1}$ with Euler integration.

$$ u_{n+1} = u_n + \pOne{t}u_n \cdot \delta t $$

Here $n$ is the time step and $\delta t$ is the time difference between time step 
$n$ and $n+1$. Plugging in the momentum equation leads to the following expression.

$$ u_{n+1} = u_n + \big( -(u_n \cdot \nabla)u_n - \nabla p_n \big) \cdot \delta t $$

$$ u_{n+1} = u_n - (u_n \cdot \nabla)u_n \delta t - \nabla p_n \delta t $$

By inserting this expression into the momentum equation we can derive the
expression for the pressure. 

$$ \nabla \cdot u_{n+1} = 0 $$

$$ \nabla \cdot u_n - \nabla \cdot (u_n \cdot \nabla)u_n \delta t - \nabla^2 p_n \delta t = 0 $$

$$ \nabla^2 p_n \delta t = - \nabla \cdot (u_n \cdot \nabla)u_n \delta t $$

$$ \nabla^2 p_n = - \nabla \cdot (u_n \cdot \nabla)u_n $$

The equation for pressure is the Poisson equation. 

Calculating the velocity at time step $n+1$ requires three steps, advection, 
solving the Poisson equation, and projection.

\subsection{Advection}

Advection is the first term of the momentum equation, $-(u \cdot \nabla)u$ which
describes the fluid's ability to transport velocities along it's own velocity 
field. This step calculates a temporary velocity field that is required to solve
the Poisson equation for the pressure field.

$$ \nabla^2 p_n = \nabla \cdot u^* $$

$$u^* = -(u_n \cdot \nabla)u_n$$

When written out for each of the three dimensions for the wind simulation, the
equation becomes

$$ u^* = (u^*_x, u^*_y, u^*_z) $$
$$ u^*_x = - \Big( \pOneD{u_x^2}{x} + \pOneD{u_x u_y}{y} + \pOneD{u_x u_z}{z}\Big) $$
$$ u^*_y = - \Big( \pOneD{u_x u_y}{x} + \pOneD{u_y^2}{y} + \pOneD{u_y u_z}{z}\Big) $$
$$ u^*_z = - \Big( \pOneD{u_x u_z}{x} + \pOneD{u_y u_z}{y} + \pOneD{u_z^2}{z}\Big) $$

TODO: Stuff

\subsection{Poisson equation}

The Poisson equation has to be solved to get the value of the pressure field. 

$$ \nabla^2 p_n = \nabla \cdot u^* $$

This equation is solved numerically using the finite difference approximation
introduced in the Background chapter. The Poisson equation can be rewritten as 
a system of linear equations on the following form.

$$ Ap = b $$

Here $A$ is a matrix, $p$ is the pressure field represented as a vector and $b$
is a vector calculated from $\nabla \cdot u^*$. The Poisson equation is discretized 
by sampling the problem domain in $n_x+1$ points in the $x$ dimension, $n_y+1$
points in the $y$ dimension and $n_z+1$ points in the $z$ dimension. The sample
points on the border of the domain are boundary points that have their values
specified by the boundary conditions of the problem. The boundary conditions
are discussed later. This means that the number of internal points, or degrees of
freedom, is $N = (n_x-1) \cdot (n_y-1) \cdot (n_z-1)$.

\subsubsection{Create the $b$ Vector}

The right hand side of the Poisson equation for the pressure is $\nabla \cdot u^*$.
To create the $b$ vector the discrete divergence of $u^*$ must be computed. The 
$b$ vector has $N$ entries, indexed with $i \in (0, n_x-1)$, $j \in (0, n_y-1)$,
$k \in (0, n_z-1)$.

$$ b_{i,j,k} = \nabla \cdot u^*_{i,j,k} = \nabla \cdot [x, y, z]_{i,j,k} = 
\Big( \pOneD{x_{i,j,k}}{x} + \pOneD{y_{i,j,k}}{y} + \pOneD{z_{i,j,k}}{z} \Big) $$

The partial derivatives can be approximated using a finite difference approximation. 
Here the second order central difference approximation is used.

$$ \pOneD{x_{i,j,k}}{x} = \frac{x_{i+1,j,k} - x_{i-1,j,k}}{2h_x} $$
$$ \pOneD{y_{i,j,k}}{y} = \frac{y_{i,j+1,k} - y_{i,j-1,k}}{2h_y} $$
$$ \pOneD{z_{i,j,k}}{z} = \frac{z_{i,j,k+1} - z_{i,j,k-1}}{2h_z} $$

\subsubsection{Solving the Poisson Equation}

TODO: Stuff

\subsection{Projection}



\subsection{Boundary Conditions}


